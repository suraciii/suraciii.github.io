<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=http://suraciii.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>使用SemanticKernel集成通义千问语言大模型</title></head><body><header id=banner><h2><a href=http://suraciii.github.io/>The Dice Maker</a></h2><nav><ul></ul></nav></header><main id=content><article><header id=post-header><h1>使用SemanticKernel集成通义千问语言大模型</h1><div><time>March 7, 2024</time></div></header><p>SemanticKernel是一个由微软开发的开源SDK，它可以将常用编程语言和大模型结合，构建AI代理来执行复杂任务（类似LangChain）。</p><p>SemanticKernel目前官方只支持集成OpenAI（包括Azure OpenAI）和Hugging Face，这篇文章介绍如何通过SemanticKernel集成其它大模型（以阿里的通义千问为例）</p><p>SemanticKernel支持C#、Python和Java，但是目前只支持C# SDK接入自定义大模型。</p><p>通义千问可以通过阿里云的模型服务灵积(DashScope)或者百炼平台接入，这里使用DashScope，因为DashScope可以使用ApiKey认证，比较方便。</p><p>SemanticKernel集成自定义LLM主要需要三步：</p><ol><li>实现对应的LLM接口客户端</li><li>根据需要的功能，实现<code>ITextGenerationService</code>,<code>IChatCompletionService</code>,<code>ITextToImageService</code>等接口，在其中调用LLM相关接口功能</li><li>注册模型服务</li></ol><h2 id=实现dashscopeclient>实现<code>DashScopeClient</code></h2><p>下面是一个实现文本生成功能的代码：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#728e00>public</span> <span style=color:#728e00>async</span> <span style=color:#434f54>Task</span>&lt;<span style=color:#434f54>IReadOnlyList</span>&lt;<span style=color:#434f54>TextContent</span>&gt;&gt; <span style=color:#434f54>GenerateTextAsync</span>(
</span></span><span style=display:flex><span>	<span style=color:#00979d>string</span> <span style=color:#434f54>prompt</span>,
</span></span><span style=display:flex><span>	<span style=color:#434f54>PromptExecutionSettings</span>? <span style=color:#434f54>executionSettings</span>,
</span></span><span style=display:flex><span>	<span style=color:#434f54>CancellationToken</span> <span style=color:#434f54>cancellationToken</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#00979d>var</span> <span style=color:#434f54>modelId</span> = <span style=color:#434f54>executionSettings</span>?.<span style=color:#434f54>ModelId</span> ?? <span style=color:#434f54>_modelId</span>;
</span></span><span style=display:flex><span>	<span style=color:#00979d>var</span> <span style=color:#434f54>endpoint</span> = <span style=color:#434f54>GetTextGenerationEndpoint</span>(); <span style=color:#95a5a6>// https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation</span>
</span></span><span style=display:flex><span>	<span style=color:#00979d>var</span> <span style=color:#434f54>request</span> = <span style=color:#434f54>CreateTextRequest</span>(<span style=color:#434f54>modelId</span>, <span style=color:#434f54>prompt</span>, <span style=color:#434f54>executionSettings</span>); <span style=color:#95a5a6>// 参考DashScope中的API文档</span>
</span></span><span style=display:flex><span>	<span style=color:#728e00>using</span> <span style=color:#434f54>var</span> <span style=color:#434f54>httpRequestMessage</span> = <span style=color:#728e00>this</span>.<span style=color:#434f54>CreatePost</span>(<span style=color:#434f54>request</span>, <span style=color:#434f54>endpoint</span>, <span style=color:#434f54>_apiKey</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00979d>string</span> <span style=color:#434f54>body</span> = <span style=color:#728e00>await</span> <span style=color:#434f54>SendRequestAndGetStringBodyAsync</span>(<span style=color:#434f54>httpRequestMessage</span>, <span style=color:#434f54>cancellationToken</span>)
</span></span><span style=display:flex><span>		.<span style=color:#434f54>ConfigureAwait</span>(<span style=color:#00979d>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00979d>var</span> <span style=color:#434f54>res</span> = <span style=color:#434f54>DeserializeResponse</span>&lt;<span style=color:#434f54>TextGenerationResponse</span>&gt;(<span style=color:#434f54>body</span>); <span style=color:#95a5a6>// 参考DashScope中的API文档</span>
</span></span><span style=display:flex><span>	<span style=color:#728e00>if</span> (<span style=color:#434f54>res</span>.<span style=color:#434f54>ErrorMessage</span> != <span style=color:#00979d>null</span>) <span style=color:#728e00>throw</span> <span style=color:#728e00>new</span> <span style=color:#434f54>KernelException</span>(<span style=color:#7f8c8d>$&#34;Error from model: {res.ErrorMessage}, code: {res.ErrorCode}&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#728e00>if</span> (<span style=color:#434f54>res</span>.<span style=color:#434f54>Output</span>!.<span style=color:#434f54>Choices</span> <span style=color:#728e00>is</span> <span style=color:#00979d>null</span>) <span style=color:#728e00>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#728e00>return</span> <span style=color:#434f54>res</span>.<span style=color:#434f54>Output</span>!.<span style=color:#434f54>Choices</span>.<span style=color:#434f54>Select</span>(<span style=color:#434f54>choice</span> =&gt; <span style=color:#728e00>new</span> <span style=color:#434f54>TextContent</span>(<span style=color:#434f54>choice</span>.<span style=color:#434f54>Message</span>.<span style=color:#434f54>Content</span>, <span style=color:#434f54>modelId</span>, <span style=color:#434f54>choice</span>, <span style=color:#434f54>Encoding</span>.<span style=color:#434f54>UTF8</span>)).<span style=color:#434f54>ToList</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=实现itextgenerationservice>实现<code>ITextGenerationService</code></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#728e00>public</span> <span style=color:#434f54>DashScopeTextGenerationService</span>(
</span></span><span style=display:flex><span>	<span style=color:#00979d>string</span> <span style=color:#434f54>model</span>,
</span></span><span style=display:flex><span>	<span style=color:#00979d>string</span> <span style=color:#434f54>apiKey</span>,
</span></span><span style=display:flex><span>	<span style=color:#434f54>Uri</span>? <span style=color:#434f54>endpoint</span> = <span style=color:#00979d>null</span>,
</span></span><span style=display:flex><span>	<span style=color:#434f54>HttpClient</span>? <span style=color:#434f54>httpClient</span> = <span style=color:#00979d>null</span>,
</span></span><span style=display:flex><span>	<span style=color:#434f54>ILoggerFactory</span>? <span style=color:#434f54>loggerFactory</span> = <span style=color:#00979d>null</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#434f54>Verify</span>.<span style=color:#434f54>NotNullOrWhiteSpace</span>(<span style=color:#434f54>model</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#434f54>Client</span> = <span style=color:#728e00>new</span> <span style=color:#434f54>DashScopeClient</span>(
</span></span><span style=display:flex><span>		<span style=color:#434f54>modelId</span>: <span style=color:#434f54>model</span>,
</span></span><span style=display:flex><span>		<span style=color:#434f54>endpoint</span>: <span style=color:#434f54>endpoint</span> ?? <span style=color:#434f54>httpClient</span>?.<span style=color:#434f54>BaseAddress</span>,
</span></span><span style=display:flex><span>		<span style=color:#434f54>apiKey</span>: <span style=color:#434f54>apiKey</span>,
</span></span><span style=display:flex><span>		<span style=color:#434f54>httpClient</span>: <span style=color:#434f54>HttpClientProvider</span>.<span style=color:#434f54>GetHttpClient</span>(<span style=color:#434f54>httpClient</span>),
</span></span><span style=display:flex><span>		<span style=color:#434f54>logger</span>: <span style=color:#434f54>loggerFactory</span>?.<span style=color:#434f54>CreateLogger</span>(<span style=color:#434f54>GetType</span>()) ?? <span style=color:#434f54>NullLogger</span>.<span style=color:#434f54>Instance</span>
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#434f54>AttributesInternal</span>.<span style=color:#434f54>Add</span>(<span style=color:#434f54>AIServiceExtensions</span>.<span style=color:#434f54>ModelIdKey</span>, <span style=color:#434f54>model</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#95a5a6>/// &lt;inheritdoc /&gt;</span>
</span></span><span style=display:flex><span><span style=color:#728e00>public</span> <span style=color:#434f54>Task</span>&lt;<span style=color:#434f54>IReadOnlyList</span>&lt;<span style=color:#434f54>TextContent</span>&gt;&gt; <span style=color:#434f54>GetTextContentsAsync</span>(<span style=color:#00979d>string</span> <span style=color:#434f54>prompt</span>, <span style=color:#434f54>PromptExecutionSettings</span>? <span style=color:#434f54>executionSettings</span> = <span style=color:#00979d>null</span>, <span style=color:#434f54>Kernel</span>? <span style=color:#434f54>kernel</span> = <span style=color:#00979d>null</span>, <span style=color:#434f54>CancellationToken</span> <span style=color:#434f54>cancellationToken</span> = <span style=color:#728e00>default</span>)
</span></span><span style=display:flex><span>	=&gt; <span style=color:#434f54>Client</span>.<span style=color:#434f54>GenerateTextAsync</span>(<span style=color:#434f54>prompt</span>, <span style=color:#434f54>executionSettings</span>, <span style=color:#434f54>cancellationToken</span>);
</span></span></code></pre></div><h2 id=注册已实现的模型服务>注册已实现的模型服务</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#728e00>public</span> <span style=color:#728e00>static</span> <span style=color:#728e00>class</span> <span style=color:#434f54>DashScopeKernelBuilderExtensions</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#728e00>public</span> <span style=color:#728e00>static</span> <span style=color:#434f54>IKernelBuilder</span> <span style=color:#434f54>AddDashScopeTextGeneration</span>(
</span></span><span style=display:flex><span>		<span style=color:#728e00>this</span> <span style=color:#434f54>IKernelBuilder</span> <span style=color:#434f54>builder</span>,
</span></span><span style=display:flex><span>		<span style=color:#00979d>string</span> <span style=color:#434f54>model</span>,
</span></span><span style=display:flex><span>		<span style=color:#00979d>string</span> <span style=color:#434f54>apiKey</span>,
</span></span><span style=display:flex><span>		<span style=color:#434f54>Uri</span>? <span style=color:#434f54>endpoint</span> = <span style=color:#00979d>null</span>,
</span></span><span style=display:flex><span>		<span style=color:#00979d>string?</span> <span style=color:#434f54>serviceId</span> = <span style=color:#00979d>null</span>,
</span></span><span style=display:flex><span>		<span style=color:#434f54>HttpClient</span>? <span style=color:#434f54>httpClient</span> = <span style=color:#00979d>null</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#434f54>builder</span>.<span style=color:#434f54>Services</span>.<span style=color:#434f54>AddKeyedSingleton</span>&lt;<span style=color:#434f54>ITextGenerationService</span>&gt;(<span style=color:#434f54>serviceId</span>, (<span style=color:#434f54>serviceProvider</span>, <span style=color:#434f54>_</span>) =&gt;
</span></span><span style=display:flex><span>			<span style=color:#728e00>new</span> <span style=color:#434f54>DashScopeTextGenerationService</span>(<span style=color:#434f54>model</span>, <span style=color:#434f54>apiKey</span>, <span style=color:#434f54>endpoint</span>, <span style=color:#434f54>HttpClientProvider</span>.<span style=color:#434f54>GetHttpClient</span>(<span style=color:#434f54>httpClient</span>, <span style=color:#434f54>serviceProvider</span>)));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#728e00>return</span> <span style=color:#434f54>builder</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这些做完后，就可以尝试通过SemanticKernel调用通义千问：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00979d>var</span> <span style=color:#434f54>kb</span> = <span style=color:#434f54>Kernel</span>.<span style=color:#434f54>CreateBuilder</span>();
</span></span><span style=display:flex><span><span style=color:#434f54>kb</span>.<span style=color:#434f54>AddDashScopeTextGeneration</span>(<span style=color:#7f8c8d>&#34;qwen-max&#34;</span>,<span style=color:#434f54>Environment</span>.<span style=color:#434f54>GetEnvironmentVariable</span>(<span style=color:#7f8c8d>&#34;DashScopeApiKey&#34;</span>)!);
</span></span><span style=display:flex><span><span style=color:#00979d>var</span> <span style=color:#434f54>sk</span> = <span style=color:#434f54>kb</span>.<span style=color:#434f54>Build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#434f54>sk</span>.<span style=color:#434f54>PromptRendered</span> += (<span style=color:#434f54>s</span>, <span style=color:#434f54>e</span>) =&gt; <span style=color:#434f54>Console</span>.<span style=color:#434f54>WriteLine</span>(<span style=color:#7f8c8d>$&#34;Prompt: \n{e.RenderedPrompt}\n&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00979d>var</span> <span style=color:#434f54>prompt</span> = <span style=color:#7f8c8d>@&#34;你是一只猫咪，你在说话时会在每句话的末尾带一声喵。
</span></span></span><span style=display:flex><span><span style=color:#7f8c8d>现在请你写一首关于{{$input}}的诗。&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00979d>var</span> <span style=color:#434f54>meow</span> = <span style=color:#434f54>sk</span>.<span style=color:#434f54>CreateFunctionFromPrompt</span>(<span style=color:#434f54>prompt</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00979d>string</span> <span style=color:#434f54>text1</span> = <span style=color:#7f8c8d>@&#34;小鱼干&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#00979d>var</span> <span style=color:#434f54>c</span> = <span style=color:#728e00>await</span> <span style=color:#434f54>sk</span>.<span style=color:#434f54>InvokeAsync</span>(<span style=color:#434f54>meow</span>, <span style=color:#728e00>new</span>() { [<span style=color:#7f8c8d>&#34;input&#34;</span>] = <span style=color:#434f54>text1</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#434f54>Console</span>.<span style=color:#434f54>WriteLine</span>(<span style=color:#7f8c8d>$&#34;\nMeow:\n{c}&#34;</span>);
</span></span></code></pre></div><p>运行<code>dotnet run</code>，查看输出：
<img src=/sk-qwen/output.png alt></p><h2 id=流式响应>流式响应</h2><p>为了增强用户体验，最好是使用SSE来进行流式响应，即不等待模型生成完所有的文字，而是不停地把已经生成的文字提供给用户。</p><p>在SemanticKernel里，需要通过实现<code>ITextGenerationService.GetStreamingTextContentsAsync</code>来提供流式内容，在<code>DashScopeClient</code>中，也需要对流内容进行处理：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>    <span style=color:#728e00>public</span> <span style=color:#728e00>async</span> <span style=color:#434f54>IAsyncEnumerable</span>&lt;<span style=color:#434f54>StreamingTextContent</span>&gt; <span style=color:#434f54>StreamGenerateTextAsync</span>(
</span></span><span style=display:flex><span>        <span style=color:#00979d>string</span> <span style=color:#434f54>prompt</span>,
</span></span><span style=display:flex><span>        <span style=color:#434f54>PromptExecutionSettings</span>? <span style=color:#434f54>executionSettings</span>,
</span></span><span style=display:flex><span><span style=color:#434f54>        [EnumeratorCancellation]</span> <span style=color:#434f54>CancellationToken</span> <span style=color:#434f54>cancellationToken</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>		<span style=color:#95a5a6>// ...</span>
</span></span><span style=display:flex><span>        <span style=color:#434f54>httpRequestMessage</span>.<span style=color:#434f54>Headers</span>.<span style=color:#434f54>Add</span>(<span style=color:#7f8c8d>&#34;X-DashScope-SSE&#34;</span>, <span style=color:#7f8c8d>&#34;enable&#34;</span>); <span style=color:#95a5a6>// 开启SSE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#728e00>using</span> <span style=color:#434f54>var</span> <span style=color:#434f54>response</span> = <span style=color:#728e00>await</span> <span style=color:#434f54>SendRequestAndGetResponseImmediatelyAfterHeadersReadAsync</span>(<span style=color:#434f54>httpRequestMessage</span>, <span style=color:#434f54>cancellationToken</span>)
</span></span><span style=display:flex><span>            .<span style=color:#434f54>ConfigureAwait</span>(<span style=color:#00979d>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#728e00>using</span> <span style=color:#434f54>var</span> <span style=color:#434f54>responseStream</span> = <span style=color:#728e00>await</span> <span style=color:#434f54>response</span>.<span style=color:#434f54>Content</span>.<span style=color:#434f54>ReadAsStreamAndTranslateExceptionAsync</span>()
</span></span><span style=display:flex><span>            .<span style=color:#434f54>ConfigureAwait</span>(<span style=color:#00979d>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00979d>var</span> <span style=color:#434f54>s</span> = <span style=color:#434f54>SseAsyncEnumerator</span>&lt;<span style=color:#434f54>TextGenerationResponse</span>&gt;.<span style=color:#434f54>EnumerateFromSseStream</span>(
</span></span><span style=display:flex><span>            <span style=color:#434f54>responseStream</span>,
</span></span><span style=display:flex><span>            <span style=color:#434f54>e</span> =&gt; <span style=color:#434f54>JsonSerializer</span>.<span style=color:#434f54>Deserialize</span>&lt;<span style=color:#434f54>TextGenerationResponse</span>&gt;(<span style=color:#434f54>e</span>)!,
</span></span><span style=display:flex><span>            <span style=color:#434f54>cancellationToken</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#728e00>await</span> <span style=color:#728e00>foreach</span> (<span style=color:#434f54>TextGenerationResponse</span> <span style=color:#434f54>res</span> <span style=color:#728e00>in</span> <span style=color:#434f54>s</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#728e00>if</span> (<span style=color:#434f54>res</span>.<span style=color:#434f54>ErrorMessage</span> != <span style=color:#00979d>null</span>) <span style=color:#728e00>throw</span> <span style=color:#728e00>new</span> <span style=color:#434f54>KernelException</span>(<span style=color:#7f8c8d>$&#34;Error from model: {res.ErrorMessage}, code: {res.ErrorCode}&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#728e00>if</span> (<span style=color:#434f54>res</span>.<span style=color:#434f54>Output</span>!.<span style=color:#434f54>Choices</span> <span style=color:#728e00>is</span> <span style=color:#00979d>null</span>) <span style=color:#728e00>continue</span>;
</span></span><span style=display:flex><span>            <span style=color:#728e00>for</span> (<span style=color:#00979d>int</span> <span style=color:#434f54>i</span> = <span style=color:#8a7b52>0</span>; <span style=color:#434f54>i</span> &lt; <span style=color:#434f54>res</span>.<span style=color:#434f54>Output</span>!.<span style=color:#434f54>Choices</span>!.<span style=color:#434f54>Count</span>; <span style=color:#434f54>i</span>++)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#00979d>var</span> <span style=color:#434f54>choice</span> = <span style=color:#434f54>res</span>.<span style=color:#434f54>Output</span>!.<span style=color:#434f54>Choices</span>![<span style=color:#434f54>i</span>];
</span></span><span style=display:flex><span>                <span style=color:#728e00>yield</span> <span style=color:#728e00>return</span> <span style=color:#728e00>new</span> <span style=color:#434f54>StreamingTextContent</span>(<span style=color:#434f54>choice</span>.<span style=color:#434f54>Message</span>.<span style=color:#434f54>Content</span>, <span style=color:#434f54>i</span>, <span style=color:#728e00>this</span>.<span style=color:#434f54>_modelId</span>, <span style=color:#434f54>choice</span>, <span style=color:#434f54>encoding</span>: <span style=color:#434f54>Encoding</span>.<span style=color:#434f54>UTF8</span>, <span style=color:#434f54>metadata</span>: <span style=color:#434f54>GetChoiceMetadata</span>(<span style=color:#434f54>res</span>, <span style=color:#434f54>choice</span>));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>这里比较麻烦的一点是在当前版本的.NET，<code>HttpClien</code>不支持直接解析SSE响应，所以需要自己手动去解析SSE响应内容，SSE响应内容类似这样：</p><pre tabindex=0><code class=language-log data-lang=log>id:1
event:result
data:{&#34;output&#34;:{&#34;finish_reason&#34;:&#34;null&#34;,&#34;text&#34;:&#34;最近&#34;},&#34;usage&#34;:{&#34;output_tokens&#34;:3,&#34;input_tokens&#34;:85},&#34;request_id&#34;:&#34;1117fb64-5dd9-9df0-a5ca-d7ee0e97032d&#34;}

id:2
event:result
data:{&#34;output&#34;:{&#34;finish_reason&#34;:&#34;null&#34;,&#34;text&#34;:&#34;最近的公园是公园，它&#34;},&#34;usage&#34;:{&#34;output_tokens&#34;:11,&#34;input_tokens&#34;:85},&#34;request_id&#34;:&#34;1117fb64-5dd9-9df0-a5ca-d7ee0e97032d&#34;}

... ... ... ...
... ... ... ...

id:8
event:result
data:{&#34;output&#34;:{&#34;finish_reason&#34;:&#34;stop&#34;,&#34;text&#34;:&#34;最近的公园是公园，它距离你的家大约1.5公里。你可以使用Google地图或者百度地图来查看具体的路线和距离。&#34;},&#34;usage&#34;:{&#34;output_tokens&#34;:51,&#34;input_tokens&#34;:85},&#34;request_id&#34;:&#34;1117fb64-5dd9-9df0-a5ca-d7ee0e97032d&#34;}
</code></pre><p>如何解析SSE响应可以参考<code>Azure/azure-sdk-for-net/blob/main/sdk/openai/Azure.AI.OpenAI/src/Helpers/SseAsyncEnumerator.cs</code></p><p>最后，在使用SemanticKernel调用时，也要调用流式方法：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#728e00>await</span> <span style=color:#728e00>foreach</span> (<span style=color:#00979d>var</span> <span style=color:#434f54>c</span> <span style=color:#728e00>in</span> <span style=color:#434f54>sk</span>.<span style=color:#434f54>InvokeStreamingAsync</span>(<span style=color:#434f54>meow</span>, <span style=color:#728e00>new</span>() { [<span style=color:#7f8c8d>&#34;input&#34;</span>] = <span style=color:#434f54>text1</span> }))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#434f54>Console</span>.<span style=color:#434f54>Clear</span>();
</span></span><span style=display:flex><span>    <span style=color:#434f54>Console</span>.<span style=color:#434f54>WriteLine</span>(<span style=color:#7f8c8d>$&#34;\nMeow:\n{c}&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article></main><footer id=footer></footer></body></html>