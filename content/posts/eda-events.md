---
title: "事件驱动架构：事件"
date: 2023-07-27T00:00:00Z
draft: true
---

当我们在系统中发送一些消息时，可能会有以下三种原因：
* 我要对方为我做某些事
* 系统中发生了某些事
* 我想知道对方的某些信息

在这三种场景中的三种不同的消息分别对应着命令，事件和查询

我喜欢用一个星巴克的例子来解释这三种形式的消息：

* 当你走进一家星巴克，向收银员点一杯拿铁，你带着强烈的意愿要求他为你调制一杯拿铁，你会一直紧紧地盯着他，直到收到小票后，你才愿意离开收银台 —— 这是命令
* 咖啡师将调好的咖啡放在取餐处，并大喊一声“X先生/女士的拿铁好了”后转身离开，他不关心你是否听到了，甚至不关心你是否还在不在此处 —— 这是事件
* 当你打完电话回到咖啡店，你想起自己曾在这里点过一杯拿铁，于是你走到取餐台，询问店员或者自己找到属于自己的那杯拿铁后，满意离开 —— 这是查询

（没错，这里的灵感来源于《星巴克不用2PC》）


| 消息 | 行为/状态变更 | 需要响应 |
|------|-------------|---------|
| 命令 | 请求发生      | 也许    |
| 事件 | 刚发生过      | 否      |
| 查询 | 无           | 是      |

## 以事件替代命令

假设一个场景：在一个电商系统中，有着若干个模块，其中包括  
* 商品目录模块(Catalog)： 负责维护商品信息
* 购物车模块(Basket)： 负责维护顾客的购物车信息
* 通知模块(Notification)： 负责给顾客发送促销通知

假设我们需要实现一个功能：在运营人员变更商品价格后，更新用户购物车中的商品价格

一个直观的实现方式是，为购物车模块实现一个用于更新顾客购物车中的商品价格的接口(在微服务系统中，这通常是一个REST或RPC的API)，并由商品目录模块在更新商品价格时进行调用

稍有经验的开发者就能看出，这样的设计有着几个问题：
* 对顾客购物车的更新阻塞了对商品价格的更新
* 在微服务系统中，网络请求具备着不确定性，尤其在请求链路较长和请求耗时较长的情况下更是如此
* 由于网络中断，或者用户取消了请求，更新中断了，数据出现了不一致

而对于具备微服务架构设计经验的人来说，很可能还会看到另外的问题：

在这种模式下，商品目录模块调用了购物车模块的一个接口，这使商品目录模块显式地依赖着购物车模块  
而购物车模块公开了一个接口，但是这个接口却不属于购物车模块自己，这个接口是为了商品目录模块而存在的，是为了响应对方的变化而存在的，并且，购物车模块中的商品信息、价格信息，是来自于商品目录模块中的业务知识，这意味着购物车模块隐式地依赖着商品目录模块  
更何况，通常这种情况下，购物车模块也会显式地依赖商品目录模块——比如在用户添加商品到购物车时，购物车也许需要检查商品是否已被下架等

这时，模块间出现双向依赖，它的坏味道足以令敏感的架构师皱起眉头，甚至坐立难安，仿佛已经看到了在未来，随着系统的不断演进，这两个模块耦合的越来越深，任何改动都必须在二者上同时进行，或者是，其中一个模块的血液逐渐被另一个模块所吸食，成为一个只有CRUD没有自己的业务逻辑的贫血模块，最后逐渐被对方吞并，成为其中的一部分


这时，我们也许可以换个角度来重新看这个功能：

> 用户购物车中的商品价格，需要**响应**商品价格信息的变更

按照这样的描述，我们来重新实现这个功能  

其中一个简单的方式是，购物车模块根本不保存商品的价格信息，而是只在需要这些信息时，才前往商品目录服务进行查询，这种方式解决了上面所说的问题，简单而有效，但是这基本只适合我们例子里的当前场景，当业务更丰富，更复杂起来后，就行不通了，比如，如果需要给购物车中有商品降价的顾客发送促销通知。
（事实上，如果没有这样的复杂场景的话，购物车模块就不会也不应该存在）

因此，此时就适合以事件的方式来完成模块间的通信

在商品价格变更后，商品目录模块发布一条商品价格已变更(CatalogItemPriceChanged)的事件到事件基础设施，而任何对此事件感兴趣的模块，都可以通过事件基础设施订阅此事件，订阅事件后，由事件基础设施负责将事件交付到相关模块，并由各模块对此进行响应

在这种情况下，商品目录模块对购物车模块的显示依赖被解除，购物车中的商品价格更新不在阻塞商品目录模块中的行为，最终也保证了数据的一致性

## 事件中的信息

正如前文所说，事件是一种消息，那事件中应该携带哪些信息，携带多少信息，就是一个非常值得谨慎设计的地方

以 商品价格已变更 事件为例，其中一个思路是，既然购物车模块需要响应这个事件，那么就为它来提供它所需要的信息吧

```golang
type CatalogItemPriceChanged {
	string CatalogItemId,
	Number Price
}
```


## 以命令替代事件





